<script type="text/javascript">
    //<![CDATA[
    function upgradeForPatch() {
        new Ajax.Request('<?php echo $this->getAjaxUpgrade() ?>', {
            method: 'get',
            onSuccess: function (transport) {

                if (transport.responseText == 1) {
                    alert('Your MageMonkey was successfully upgraded.');
                }
                else {
                    alert('En error happened when upgrading your MageMonkey. Please contact our support or try again later.');
                }
            }
        });
    }
    //]]>
</script>

<?php

if($this->tableExists()) {
    Mage::log('tableExists', null, 'santiago.log', true);
    $blocks = array(
        array('block_name' => 'ebizmarts_abandonedcart/email_order_items', 'is_allowed' => 1),
        array('block_name' => 'ebizmarts_autoresponder/email_backtostock_item', 'is_allowed' => 1),
        array('block_name' => 'ebizmarts_autoresponder/email_related_items', 'is_allowed' => 1),
        array('block_name' => 'ebizmarts_autoresponder/email_review_items', 'is_allowed' => 1),
        array('block_name' => 'ebizmarts_autoresponder/email_wishlist_items', 'is_allowed' => 1),
    );
    foreach($blocks as $item){
        Mage::log('item '.$item['block_name'], null, 'santiago.log', true);
        $rowExists = Mage::getResourceModel('admin/block_collection')
            ->addFieldToFilter('block_name', array('eq' => $item['block_name']));
        $row = $rowExists->getFirstItem();
        Mage::log($row, null, 'santiago.log', true);
        if(!$row->getBlockId()){
            Mage::log('notBlockId', null, 'santiago.log', true);
            echo $this->getButtonHtml();
            return;
        }
    }
}?>